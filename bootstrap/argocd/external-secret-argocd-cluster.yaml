apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: argocd-cluster
  namespace: argocd
  labels:
    app.kubernetes.io/name: argocd-cluster
    app.kubernetes.io/part-of: gke-bootstrap
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secret-manager
    kind: SecretStore
  target:
    name: argocd-cluster
    creationPolicy: Owner
    template:
      # ArgoCD cluster secret format for in-cluster access
      # All cluster metadata is stored as annotations for ApplicationSet consumption
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
        annotations:
          # Cluster identification
          gcp-hcp/cluster-name: "{{ .cluster_name }}"
          gcp-hcp/cluster-type: "{{ .cluster_type }}"
          gcp-hcp/infra-id: "{{ .infra_id }}"
          # GCP context
          gcp-hcp/project-id: "{{ .project_id }}"
          gcp-hcp/region: "{{ .region }}"
          # Deployment context
          gcp-hcp/environment: "{{ .environment }}"
          gcp-hcp/sector: "{{ .sector }}"
          # Git configuration for ArgoCD applications
          gcp-hcp/git-repo: "{{ .git_repo }}"
          gcp-hcp/git-revision: "{{ .git_revision }}"
      stringData:
        # ArgoCD cluster secret required fields
        name: "{{ .cluster_name }}"
        server: https://kubernetes.default.svc
        config: |
          {
            "tlsClientConfig": {
              "insecure": false
            }
          }
  dataFrom:
    - extract:
        # Static secret name - each cluster project has one argocd-cluster secret
        key: argocd-cluster
